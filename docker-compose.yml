services:
  # Main meeting bot service (NodeJS)
  meeting-bot:
    build:
      context: .
      dockerfile: Dockerfile.development
    environment:
      - NODE_ENV=development
      - MAX_RECORDING_DURATION_MINUTES=180
      - MEETING_INACTIVITY_MINUTES=15
      - INACTIVITY_DETECTION_START_DELAY_MINUTES=5
    ports:
      - "5001:3000"
    volumes:
      - .:/usr/src/app
      - ./assets/screenshots:/usr/src/app/assets/screenshots
      - /usr/src/app/node_modules
    command: [ "/bin/bash", "./start.sh" ]

  # Controller service (Python) - monitors Pub/Sub and creates K8s jobs
  controller:
    build:
      context: .
      dockerfile: Dockerfile.controller
    environment:
      - GCP_PROJECT_ID=${GCP_PROJECT_ID}
      - PUBSUB_SUBSCRIPTION=${PUBSUB_SUBSCRIPTION}
      - MANAGER_IMAGE=${MANAGER_IMAGE:-gcr.io/your-project/meeting-manager:latest}
      - K8S_NAMESPACE=${K8S_NAMESPACE:-default}
      - GCS_BUCKET=${GCS_BUCKET}
      - MEETING_BOT_API_URL=http://meeting-bot:3000
      - POLL_INTERVAL=10
    depends_on:
      - meeting-bot
    # Note: In production, this should run in Kubernetes with proper RBAC

    # Manager service (Python) - processes individual meetings
    # This is typically run as K8s Jobs, but can be tested standalone
  manager:
    build:
      context: .
      dockerfile: Dockerfile.manager
    environment:
      - MEETING_URL=${MEETING_URL}
      - MEETING_ID=${MEETING_ID}
      - GCS_PATH=${GCS_PATH}
      - GCS_BUCKET=${GCS_BUCKET}
      - MEETING_BOT_API_URL=http://meeting-bot:3000
      # Offline transcription/diarization (optional)
      - TRANSCRIPTION_MODE=${TRANSCRIPTION_MODE:-online}
      - WHISPER_CLI_PATH=${WHISPER_CLI_PATH:-/app/tools/whisper.cpp/build/bin/whisper-cli}
      - WHISPER_MODEL_PATH=${WHISPER_MODEL_PATH:-/app/tools/whisper.cpp/models/ggml-base.en.bin}
      - SPEECHBRAIN_SPKREC_DIR=${SPEECHBRAIN_SPKREC_DIR:-/app/tools/speechbrain/spkrec-ecapa-voxceleb}
      # GCS auth (ADC) for offline mode when downloading gs:// URIs
      - GOOGLE_APPLICATION_CREDENTIALS=/creds/adc.json
      - GOOGLE_CLOUD_PROJECT=${GOOGLE_CLOUD_PROJECT}
    depends_on:
      - meeting-bot
    volumes:
      # Mount an ADC json file from the host (create/populate via `gcloud auth application-default login`)
      - ${GOOGLE_APPLICATION_CREDENTIALS_PATH:-/tmp/adc.json}:/creds/adc.json:ro
      # Capture offline pipeline outputs locally
      - ./test-results/container-e2e:/out
    profiles:
      - test-manager # Only run when explicitly requested

volumes:
  cache:
