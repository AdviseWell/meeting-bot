#!/bin/bash

# Simple XVFB wrapper without PulseAudio overhead

# Forward SIGTERM to child processes
trap 'echo "Sending SIGTERM to child processes"; kill -TERM "$child" "$xvfb_pid" 2>/dev/null' SIGTERM SIGINT

# Set up writable XDG directories for Chrome/Chromium
# This prevents the "chrome_crashpad_handler: --database is required" crash
export XDG_CONFIG_HOME=/tmp/chrome/config
export XDG_CACHE_HOME=/tmp/chrome/cache
mkdir -p "$XDG_CONFIG_HOME" "$XDG_CACHE_HOME"
echo "XDG directories configured: $XDG_CONFIG_HOME, $XDG_CACHE_HOME"

# Set display
export DISPLAY=:99

# Start Xvfb in the background
echo "Starting Xvfb..."
Xvfb :99 -screen 0 1280x720x24 -ac -nolisten tcp -dpi 96 +extension RANDR &
xvfb_pid=$!

echo "Xvfb started with PID: $xvfb_pid"

# Wait for X server to be ready
sleep 2

# Execute the main application
echo "Starting application..."
"$@" &
child=$!

# Wait for the child process to finish
wait "$child"
child_exit_code=$?

# Cleanup processes
echo "Cleaning up processes..."
kill -TERM "$xvfb_pid" 2>/dev/null
wait "$xvfb_pid" 2>/dev/null

# Exit with the application's exit code
exit "$child_exit_code"
