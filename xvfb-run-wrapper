#!/bin/bash

# Forward SIGTERM to child processes
trap 'echo "sending SIGABRT to child"; kill -SIGABRT "$child" 2>/dev/null; kill -TERM "$pulse_pid" 2>/dev/null' SIGTERM SIGINT

# Start PulseAudio in daemon mode with a dummy sink for audio capture
echo "Starting PulseAudio..."
pulseaudio --start --exit-idle-time=-1 --log-target=stderr &
pulse_pid=$!
sleep 2

# Load a dummy output module (null sink) for audio to flow through
echo "Loading PulseAudio null sink..."
pactl load-module module-null-sink sink_name=dummy_output sink_properties=device.description="Virtual_Dummy_Output"
pactl set-default-sink dummy_output

# Start Xvfb
Xvfb :99 -screen 0 1280x720x24 &
xvfb_pid=$!

# Wait a moment for Xvfb to start
sleep 1

# Start your application
DISPLAY=:99 "$@" &
child=$!

# Wait for the child process to finish. have to use these both commands
wait "$child"
tail --pid="$child" -f /dev/null
child_exit_code=$?

# Cleanup processes
echo "Cleaning up processes..."
kill -TERM "$xvfb_pid" 2>/dev/null
wait "$xvfb_pid"

pulseaudio --kill 2>/dev/null
kill -TERM "$pulse_pid" 2>/dev/null
wait "$pulse_pid" 2>/dev/null

# Exit with the application's exit code
exit "$child_exit_code"
