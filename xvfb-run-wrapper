#!/bin/bash

# Forward SIGTERM to child processes
trap 'echo "sending SIGABRT to child"; kill -SIGABRT "$child" 2>/dev/null' SIGTERM SIGINT

# Start Xvfb
Xvfb :99 -screen 0 1280x720x24 &
xvfb_pid=$!

# Start PulseAudio daemon with virtual audio sink
pulseaudio -D --exit-idle-time=-1 --system --disallow-exit --disallow-module-loading=0 2>/dev/null || \
pulseaudio -D --exit-idle-time=-1 2>/dev/null

# Create virtual audio sink and source for Chrome to use
pactl load-module module-null-sink sink_name=DummyOutput sink_properties=device.description="Virtual_Sink" 2>/dev/null
pactl load-module module-virtual-source source_name=VirtualMic master=DummyOutput.monitor 2>/dev/null

# Set default audio devices
pacmd set-default-sink DummyOutput 2>/dev/null
pacmd set-default-source VirtualMic 2>/dev/null

# Wait a moment for Xvfb and PulseAudio to start
sleep 1

# Start your application
DISPLAY=:99 "$@" &
child=$!

# Wait for the child process to finish. have to use these both commands
wait "$child"
tail --pid="$child" -f /dev/null
child_exit_code=$?

# Cleanup Xvfb process
kill -TERM "$xvfb_pid" 2>/dev/null
wait "$xvfb_pid"

# Exit with the application's exit code
exit "$child_exit_code"
